<!DOCTYPE html>
<html>
  <head>
	<script type="text/javascript" src="/charts/js/lib/d3.js" charset="utf-8"></script>
	<script type="text/javascript" src="/charts/js/candles.js"></script>
	<script type="text/javascript" src="/charts/js/macd.js"></script>
	<script type="text/javascript" src="/charts/js/obv.js"></script>
	<script type="text/javascript" src="/charts/js/const.js"></script>
	<link rel="stylesheet" type="text/css" href="/charts/css/chart.css">
	<title>EOD OHLC Candles</title>
  </head>
  <body>
	<div class="ctrls">
		<label for="daysPer">Days/Candle: </label><input type="number" value="1" id="daysPer"/>
		<label for="zoom">Zoom: </label><input type="range" max="2.5" value="1" min="0.4" step="0.025" id="zoom"/>
		<label for="volmult">Volume: </label><input type="range" max="0.001" value="0.00001" min="0.0000001" step="0.0000001" id="volmult"/>
		<select id="symselect"></select>
	</div>
	<br/>
	<div class="candlesticks"></div>
	<br/>
	<div class="obv">OBV:
		<input type="checkbox" id="obvPoints"/><label for="obvPoints">Points</label>
	</div>
	<br/>
	<div class="macd">MACD:
		<input type="checkbox" id="macdPoints"/><label for="macdPoints">Mpts</label>
		<input type="checkbox" id="sigPoints"/><label for="sigPoints">Spts</label>
		<input type="checkbox" id="macdHisto"/><label for="macdHisto">Histogram</label>
	</div>
	
	<script type="text/javascript">
		
	var daysPerCandle = 1,
	yTicks = 10,
	volmult = 0.000001,
	symbolsLoaded = false,
	candleData;

	function aggregate(eod) {
		if (typeof candleData === 'undefined') { candleData = eod }
		
		if (daysPerCandle > 1) {
			var out = [],
			start = 0,
			end = daysPerCandle;
			
			while (end <= eod.length) {
				var chunk = eod.slice(start, end);
				var agg = {
					"Date": chunk[0].Date,
					"Open": +chunk[chunk.length - 1].Open, 
					"High": d3.max(chunk.map(function(d) { return +d.High })),
					"Low": d3.min(chunk.map(function(d) { return +d.Low })),
					"Close": +chunk[0].Close,
					"Volume": d3.sum(chunk.map(function(d) { return +d.Volume })),
					//"Adj Close": chunk[0]["Adj Close"]
					}
				out.push(agg);
				
				start = end;
				end = start + daysPerCandle;
			}
			buildCandles(out);
		} else {
			buildCandles(candleData);			
		}
		
		d3.select("title")
			.html(function() {
				return location.hash.substr(1) + ' from ' + candleData[candleData.length - 1].Date
				});
	}
	
	function fetchData() {
		
		if (symbolsLoaded == false) {
			d3.json(dataServer + '/symbols.json?order=biggest', function(d) {
				var dropdown = d3.select("#symselect")
				
				dropdown.selectAll("option")
					.data(d).enter()
					.append("option")
					.attr("value", function(d) { return d })
					.text(String)
				
				dropdown.select("option[selected=selected]")
					.attr("selected", null);
				
				dropdown.select("option[value=" + location.hash.substr(1) + "]")
					.attr("selected", "selected");
				
			});
			symbolsLoaded = true;
		}
		
		if (typeof candleData === 'undefined') {			
			d3.csv(dataServer + '/data/csv/_' + location.hash.substr(1) + '.csv', aggregate);
		} else	{
			aggregate(candleData);
		}
		
		d3.json(dataServer
				+ '/macd.json'
				+ '?fast=' + fast
				+ '&slow=' + slow
				+ '&symbol=' + location.hash.substr(1)
				+ '&signal=' + signal
				+ '&dpc=' + daysPerCandle,
				buildMacd);
		
		d3.json(dataServer
				+ '/obv.json'
				+ '?symbol=' + location.hash.substr(1)
				+ '&dpc=' + daysPerCandle,
				buildObv);
	}
	</script>
	<script type="text/javascript" src="/charts/js/events.js"></script>
  </body>
</html>





